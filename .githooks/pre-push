#!/bin/bash

# Pre-push hook: validates post dates are GMT and not in the future

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/post-checks.sh"

tz_errors=()
future_errors=()
current_timestamp=$(date -u +%s)

for file in _posts/*.md; do
    if [[ -f "$file" ]]; then
        if ! check_timezone "$file"; then
            tz_errors+=("$file: $(get_date_line "$file")")
        fi

        if ! check_not_future "$file" "$current_timestamp"; then
            future_errors+=("$file: $(get_date_line "$file")")
        fi
    fi
done

if [[ ${#tz_errors[@]} -gt 0 ]]; then
    echo "ERROR: Posts with non-GMT timezones found:"
    for err in "${tz_errors[@]}"; do
        echo "  $err"
    done
    echo ""
    echo "Please update to +0000 before pushing."
    exit 1
fi

if [[ ${#future_errors[@]} -gt 0 ]]; then
    echo "ERROR: Posts with future dates found:"
    for err in "${future_errors[@]}"; do
        echo "  $err"
    done
    echo ""
    echo "Add 'future: true' to front matter to override, or fix the date."
    exit 1
fi

exit 0
